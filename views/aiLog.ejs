<%- include('templates/header') %>

<div class="min-h-screen flex flex-col items-center bg-gray-100 py-6">
    <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-4xl">
        <h1 class="text-2xl font-bold mb-4">Conversation History</h1>
        <% if (chatHistories.length > 0) { %>
            <ul>
                <% chatHistories.forEach(chat => { %>
                    <li class="mb-4">
                        <p><strong>Date:</strong> <%= new Date(chat.date).toLocaleString() %></p>
                        <button class="save-btn" data-id="<%= chat._id %>">Save</button>
                        <button class="delete-btn" data-id="<%= chat._id %>">Delete</button>
                    </li>
                <% }) %>
            </ul>
        <% } else { %>
            <p class="text-gray-500">No conversation history found.</p>
        <% } %>
        <a href="/home" class="mt-4 inline-block bg-red-400 text-white py-2 px-4 rounded hover:bg-red-600">Go Home</a>
    </div>
</div>

<script>
    document.querySelectorAll('.save-btn').forEach(button => {
        button.addEventListener('click', () => {
            const chatId = button.getAttribute('data-id');
            fetch(`/ai/saveChat/${chatId}`, { method: 'POST' })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `chat_${chatId}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(err => console.error('Error saving chat:', err));
        });
    });

    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', () => {
            const chatId = button.getAttribute('data-id');
            fetch(`/ai/deleteChat/${chatId}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        button.closest('li').remove();
                    } else {
                        console.error('Error deleting chat:', response);
                    }
                })
                .catch(err => console.error('Error deleting chat:', err));
        });
    });
</script>

<%- include('templates/footer') %>
